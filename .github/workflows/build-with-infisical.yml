name: Build & Push Docker Image — Infisical Secrets

on:
  push:
    branches:
      - main
      - develop
  pull_request:
    branches:
      - main
  workflow_dispatch:
    inputs:
      environment:
        description: "Target environment (dev / staging / prod)"
        required: true
        default: "dev"
        type: choice
        options:
          - dev
          - staging
          - prod

env:
  IMAGE_NAME: test-workflow-app
  INFISICAL_PROJECT_ID: ${{ secrets.INFISICAL_PROJECT_ID }}
  DOCKERHUB_IMAGE: ${{ secrets.DOCKERHUB_USERNAME }}/test-workflow-app

jobs:
  fetch-secrets-and-build:
    name: Fetch Secrets then Build Image
    runs-on: ubuntu-latest
    environment: ${{ github.event.inputs.environment || 'dev' }}

    permissions:
      contents: read

    steps:
      # Checkout
      - name: Checkout Repository
        uses: actions/checkout@v4

      # Install Infisical CLI (new official installation method)
      # Ref: https://infisical.com/docs/cli/overview#installation
      - name: Install Infisical CLI
        run: |
          curl -1sLf \
            'https://artifacts.infisical.com/setup.deb.sh' \
            | sudo -E bash
          sudo apt-get update -y && sudo apt-get install -y infisical
          infisical --version

      # Fetch secrets via fetch-infisical-env.sh
      #   Required GitHub Secrets:
      #     INFISICAL_TOKEN      → Universal Auth machine identity token
      #     INFISICAL_PROJECT_ID → Project UUID from Infisical dashboard

      - name: Fetch Secrets via Shell Script (fetch-infisical-env.sh)
        run: bash ./fetch-infisical-env.sh "$APP_ENV" "$INFISICAL_PROJECT_ID" .env
        env:
          INFISICAL_TOKEN: ${{ secrets.INFISICAL_TOKEN }}
          INFISICAL_PROJECT_ID: ${{ env.INFISICAL_PROJECT_ID }}
          APP_ENV: ${{ github.event.inputs.environment || 'dev' }}

      # Verify .env was generated
      - name: Verify .env File Generated
        run: |
          echo "──────────────────────────────────────────"
          echo "  .env file generated by fetch-infisical-env.sh"
          echo "  Keys present (values are masked by GitHub):"
          grep -v '^#' .env | grep '=' | cut -d'=' -f1 | sed 's/^/  • /'
          echo "──────────────────────────────────────────"

      # Set up Docker Buildx
      - name: Set Up Docker Buildx
        uses: docker/setup-buildx-action@v3

      # Log in to Docker Hub
      - name: Log in to Docker Hub
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKERHUB_USERNAME }}
          password: ${{ secrets.DOCKERHUB_TOKEN }}

      # Extract Docker metadata (tags & labels)
      - name: Extract Docker Metadata
        id: meta
        uses: docker/metadata-action@v5
        with:
          images: ${{ env.DOCKERHUB_IMAGE }}
          tags: |
            type=sha,prefix=${{ github.event.inputs.environment || 'dev' }}-
            type=ref,event=branch
            type=raw,value=latest,enable=${{ github.ref == 'refs/heads/main' }}

      # Build & Push Docker Image
      - name: Build & Push Docker Image (Docker Hub)
        uses: docker/build-push-action@v5
        with:
          context: .
          file: ./Dockerfile
          push: ${{ github.event_name != 'pull_request' }}
          tags: ${{ steps.meta.outputs.tags }}
          labels: ${{ steps.meta.outputs.labels }}
          build-args: |
            APP_ENV=${{ github.event.inputs.environment || 'dev' }}
            GIT_SHA=${{ github.sha }}
          cache-from: type=gha
          cache-to: type=gha,mode=max






